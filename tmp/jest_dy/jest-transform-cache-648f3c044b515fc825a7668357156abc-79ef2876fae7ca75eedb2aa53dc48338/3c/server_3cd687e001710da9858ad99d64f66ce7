c9fc57491d1f76c6bf1068f62a785b2f
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildServer = buildServer;
const fastify_1 = __importDefault(require("fastify"));
const cookie_1 = __importDefault(require("@fastify/cookie"));
const jwt_1 = __importDefault(require("@fastify/jwt"));
const helmet_1 = __importDefault(require("@fastify/helmet"));
const swagger_1 = __importDefault(require("@fastify/swagger"));
const swagger_ui_1 = __importDefault(require("@fastify/swagger-ui"));
const multipart_1 = __importDefault(require("@fastify/multipart"));
const zod_1 = require("zod");
const dotenv_1 = __importDefault(require("dotenv"));
// Route modules
const statements_js_1 = __importDefault(require("./api/statements.js"));
const jobs_js_1 = __importDefault(require("./api/jobs.js"));
dotenv_1.default.config();
function createLogger() {
    const isProd = process.env.NODE_ENV === 'production';
    if (isProd)
        return true;
    return {
        transport: {
            target: 'pino-pretty',
            options: {
                translateTime: 'SYS:standard',
                ignore: 'pid,hostname',
            },
        },
    };
}
async function buildServer() {
    const server = (0, fastify_1.default)({
        logger: createLogger(),
    });
    // ---------------- Plugins ----------------
    await server.register(helmet_1.default);
    await server.register(cookie_1.default, {
        secret: process.env.COOKIE_SECRET || 'supersecret',
    });
    await server.register(jwt_1.default, {
        secret: process.env.JWT_SECRET || 'changeme',
        sign: { expiresIn: '60m' },
        cookie: {
            cookieName: 'refresh',
            signed: false,
        },
    });
    await server.register(swagger_1.default, {
        openapi: {
            info: { title: 'Pocket Financial Advisor API', version: '0.1.0' },
        },
    });
    await server.register(swagger_ui_1.default, { routePrefix: '/docs' });
    await server.register(multipart_1.default, {
        attachFieldsToBody: false,
        limits: {
            fileSize: 10 * 1024 * 1024, // 10MB
        },
    });
    // ---------------- Schemas ----------------
    const StatusSchema = {
        type: 'object',
        properties: {
            status: { type: 'string' },
        },
        required: ['status'],
    };
    server.get('/healthz', {
        schema: {
            tags: ['system'],
            response: { 200: StatusSchema },
        },
    }, async () => ({ status: 'ok' }));
    server.get('/readyz', {
        schema: {
            tags: ['system'],
            response: { 200: StatusSchema },
        },
    }, async () => ({ status: 'ready' }));
    // Auth routes ----------------------------
    const SignupLoginSchema = zod_1.z.object({
        email: zod_1.z.string().email(),
        password: zod_1.z.string().min(8).max(128),
    });
    server.post('/api/v1/auth/signup', {
        schema: {
            tags: ['auth'],
            body: SignupLoginSchema,
            response: { 200: zod_1.z.object({ token: zod_1.z.string() }) },
        },
    }, async (request, reply) => {
        const { email, password } = request.body;
        // TODO: Persist user with Prisma, ensure unique email
        const userId = '1';
        const token = server.jwt.sign({ sub: userId, email });
        reply.setCookie('refresh', token, {
            path: '/',
            httpOnly: true,
            sameSite: 'lax',
            secure: process.env.NODE_ENV === 'production',
            maxAge: 60 * 60,
        });
        return { token };
    });
    server.post('/api/v1/auth/login', {
        schema: {
            tags: ['auth'],
            body: SignupLoginSchema,
            response: { 200: zod_1.z.object({ token: zod_1.z.string() }) },
        },
    }, async (request, reply) => {
        const { email, password } = request.body;
        // TODO: Verify credentials via Prisma
        const userId = '1';
        const token = server.jwt.sign({ sub: userId, email });
        reply.setCookie('refresh', token, {
            path: '/',
            httpOnly: true,
            sameSite: 'lax',
            secure: process.env.NODE_ENV === 'production',
            maxAge: 60 * 60,
        });
        return { token };
    });
    server.get('/api/v1/auth/me', {
        preHandler: [async (request, reply) => {
                try {
                    await request.jwtVerify();
                }
                catch (err) {
                    return reply.send(err);
                }
            }],
        schema: {
            tags: ['auth'],
            response: { 200: zod_1.z.object({ userId: zod_1.z.string(), email: zod_1.z.string().email() }) },
        },
    }, async (request) => {
        const { sub, email } = request.user;
        return { userId: sub, email };
    });
    // Domain routes
    await server.register(statements_js_1.default);
    await server.register(jobs_js_1.default);
    return server;
}
// If not in test mode, start server immediately
if (process.env.NODE_ENV !== 'test') {
    buildServer().then((server) => {
        const port = parseInt(process.env.PORT || '3000', 10);
        server.listen({ port, host: '0.0.0.0' })
            .catch((err) => {
            server.log.error(err);
            process.exit(1);
        });
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QUcsQ0FBQyxJQUFJLElBQUksTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3RELE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxDQUFDO2FBQ3JDLEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ2IsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdEIsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsQixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbHVjYXN3aGVsYW4vZmluYW5jaWFsX2Fkdmlzb3Ivc3JjL3NlcnZlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRmFzdGlmeSwgeyBGYXN0aWZ5SW5zdGFuY2UgfSBmcm9tICdmYXN0aWZ5JztcbmltcG9ydCBjb29raWUgZnJvbSAnQGZhc3RpZnkvY29va2llJztcbmltcG9ydCBqd3QgZnJvbSAnQGZhc3RpZnkvand0JztcbmltcG9ydCBoZWxtZXQgZnJvbSAnQGZhc3RpZnkvaGVsbWV0JztcbmltcG9ydCBzd2FnZ2VyIGZyb20gJ0BmYXN0aWZ5L3N3YWdnZXInO1xuaW1wb3J0IHN3YWdnZXJVaSBmcm9tICdAZmFzdGlmeS9zd2FnZ2VyLXVpJztcbmltcG9ydCBtdWx0aXBhcnQgZnJvbSAnQGZhc3RpZnkvbXVsdGlwYXJ0JztcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnO1xuaW1wb3J0IGRvdGVudiBmcm9tICdkb3RlbnYnO1xuXG4vLyBSb3V0ZSBtb2R1bGVzXG5pbXBvcnQgc3RhdGVtZW50c1JvdXRlcyBmcm9tICcuL2FwaS9zdGF0ZW1lbnRzLmpzJztcbmltcG9ydCBqb2JzUm91dGVzIGZyb20gJy4vYXBpL2pvYnMuanMnO1xuXG5kb3RlbnYuY29uZmlnKCk7XG5cbmZ1bmN0aW9uIGNyZWF0ZUxvZ2dlcigpIHtcbiAgY29uc3QgaXNQcm9kID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdwcm9kdWN0aW9uJztcbiAgaWYgKGlzUHJvZCkgcmV0dXJuIHRydWU7XG5cbiAgcmV0dXJuIHtcbiAgICB0cmFuc3BvcnQ6IHtcbiAgICAgIHRhcmdldDogJ3Bpbm8tcHJldHR5JyxcbiAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgdHJhbnNsYXRlVGltZTogJ1NZUzpzdGFuZGFyZCcsXG4gICAgICAgIGlnbm9yZTogJ3BpZCxob3N0bmFtZScsXG4gICAgICB9LFxuICAgIH0sXG4gIH0gYXMgY29uc3Q7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBidWlsZFNlcnZlcigpOiBQcm9taXNlPEZhc3RpZnlJbnN0YW5jZT4ge1xuICBjb25zdCBzZXJ2ZXI6IEZhc3RpZnlJbnN0YW5jZSA9IEZhc3RpZnkoe1xuICAgIGxvZ2dlcjogY3JlYXRlTG9nZ2VyKCksXG4gIH0pO1xuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0gUGx1Z2lucyAtLS0tLS0tLS0tLS0tLS0tXG4gIGF3YWl0IHNlcnZlci5yZWdpc3RlcihoZWxtZXQpO1xuICBhd2FpdCBzZXJ2ZXIucmVnaXN0ZXIoY29va2llLCB7XG4gICAgc2VjcmV0OiBwcm9jZXNzLmVudi5DT09LSUVfU0VDUkVUIHx8ICdzdXBlcnNlY3JldCcsXG4gIH0pO1xuXG4gIGF3YWl0IHNlcnZlci5yZWdpc3Rlcihqd3QsIHtcbiAgICBzZWNyZXQ6IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgfHwgJ2NoYW5nZW1lJyxcbiAgICBzaWduOiB7IGV4cGlyZXNJbjogJzYwbScgfSxcbiAgICBjb29raWU6IHtcbiAgICAgIGNvb2tpZU5hbWU6ICdyZWZyZXNoJyxcbiAgICAgIHNpZ25lZDogZmFsc2UsXG4gICAgfSxcbiAgfSk7XG5cbiAgYXdhaXQgc2VydmVyLnJlZ2lzdGVyKHN3YWdnZXIsIHtcbiAgICBvcGVuYXBpOiB7XG4gICAgICBpbmZvOiB7IHRpdGxlOiAnUG9ja2V0IEZpbmFuY2lhbCBBZHZpc29yIEFQSScsIHZlcnNpb246ICcwLjEuMCcgfSxcbiAgICB9LFxuICB9KTtcblxuICBhd2FpdCBzZXJ2ZXIucmVnaXN0ZXIoc3dhZ2dlclVpLCB7IHJvdXRlUHJlZml4OiAnL2RvY3MnIH0pO1xuXG4gIGF3YWl0IHNlcnZlci5yZWdpc3RlcihtdWx0aXBhcnQsIHtcbiAgICBhdHRhY2hGaWVsZHNUb0JvZHk6IGZhbHNlLFxuICAgIGxpbWl0czoge1xuICAgICAgZmlsZVNpemU6IDEwICogMTAyNCAqIDEwMjQsIC8vIDEwTUJcbiAgICB9LFxuICB9KTtcblxuICAvLyAtLS0tLS0tLS0tLS0tLS0tIFNjaGVtYXMgLS0tLS0tLS0tLS0tLS0tLVxuICBjb25zdCBTdGF0dXNTY2hlbWEgPSB7XG4gICAgdHlwZTogJ29iamVjdCcsXG4gICAgcHJvcGVydGllczoge1xuICAgICAgc3RhdHVzOiB7IHR5cGU6ICdzdHJpbmcnIH0sXG4gICAgfSxcbiAgICByZXF1aXJlZDogWydzdGF0dXMnXSxcbiAgfSBhcyBjb25zdDtcblxuICBzZXJ2ZXIuZ2V0KCcvaGVhbHRoeicsIHtcbiAgICBzY2hlbWE6IHtcbiAgICAgIHRhZ3M6IFsnc3lzdGVtJ10sXG4gICAgICByZXNwb25zZTogeyAyMDA6IFN0YXR1c1NjaGVtYSB9LFxuICAgIH0sXG4gIH0sIGFzeW5jICgpID0+ICh7IHN0YXR1czogJ29rJyB9KSk7XG5cbiAgc2VydmVyLmdldCgnL3JlYWR5eicsIHtcbiAgICBzY2hlbWE6IHtcbiAgICAgIHRhZ3M6IFsnc3lzdGVtJ10sXG4gICAgICByZXNwb25zZTogeyAyMDA6IFN0YXR1c1NjaGVtYSB9LFxuICAgIH0sXG4gIH0sIGFzeW5jICgpID0+ICh7IHN0YXR1czogJ3JlYWR5JyB9KSk7XG5cbiAgLy8gQXV0aCByb3V0ZXMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4gIGNvbnN0IFNpZ251cExvZ2luU2NoZW1hID0gei5vYmplY3Qoe1xuICAgIGVtYWlsOiB6LnN0cmluZygpLmVtYWlsKCksXG4gICAgcGFzc3dvcmQ6IHouc3RyaW5nKCkubWluKDgpLm1heCgxMjgpLFxuICB9KTtcblxuICBzZXJ2ZXIucG9zdCgnL2FwaS92MS9hdXRoL3NpZ251cCcsIHtcbiAgICBzY2hlbWE6IHtcbiAgICAgIHRhZ3M6IFsnYXV0aCddLFxuICAgICAgYm9keTogU2lnbnVwTG9naW5TY2hlbWEsXG4gICAgICByZXNwb25zZTogeyAyMDA6IHoub2JqZWN0KHsgdG9rZW46IHouc3RyaW5nKCkgfSkgfSxcbiAgICB9LFxuICB9LCBhc3luYyAocmVxdWVzdCwgcmVwbHkpID0+IHtcbiAgICBjb25zdCB7IGVtYWlsLCBwYXNzd29yZCB9ID0gcmVxdWVzdC5ib2R5IGFzIHouaW5mZXI8dHlwZW9mIFNpZ251cExvZ2luU2NoZW1hPjtcblxuICAgIC8vIFRPRE86IFBlcnNpc3QgdXNlciB3aXRoIFByaXNtYSwgZW5zdXJlIHVuaXF1ZSBlbWFpbFxuICAgIGNvbnN0IHVzZXJJZCA9ICcxJztcblxuICAgIGNvbnN0IHRva2VuID0gc2VydmVyLmp3dC5zaWduKHsgc3ViOiB1c2VySWQsIGVtYWlsIH0pO1xuXG4gICAgcmVwbHkuc2V0Q29va2llKCdyZWZyZXNoJywgdG9rZW4sIHtcbiAgICAgIHBhdGg6ICcvJyxcbiAgICAgIGh0dHBPbmx5OiB0cnVlLFxuICAgICAgc2FtZVNpdGU6ICdsYXgnLFxuICAgICAgc2VjdXJlOiBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nLFxuICAgICAgbWF4QWdlOiA2MCAqIDYwLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHsgdG9rZW4gfTtcbiAgfSk7XG5cbiAgc2VydmVyLnBvc3QoJy9hcGkvdjEvYXV0aC9sb2dpbicsIHtcbiAgICBzY2hlbWE6IHtcbiAgICAgIHRhZ3M6IFsnYXV0aCddLFxuICAgICAgYm9keTogU2lnbnVwTG9naW5TY2hlbWEsXG4gICAgICByZXNwb25zZTogeyAyMDA6IHoub2JqZWN0KHsgdG9rZW46IHouc3RyaW5nKCkgfSkgfSxcbiAgICB9LFxuICB9LCBhc3luYyAocmVxdWVzdCwgcmVwbHkpID0+IHtcbiAgICBjb25zdCB7IGVtYWlsLCBwYXNzd29yZCB9ID0gcmVxdWVzdC5ib2R5IGFzIHouaW5mZXI8dHlwZW9mIFNpZ251cExvZ2luU2NoZW1hPjtcblxuICAgIC8vIFRPRE86IFZlcmlmeSBjcmVkZW50aWFscyB2aWEgUHJpc21hXG4gICAgY29uc3QgdXNlcklkID0gJzEnO1xuXG4gICAgY29uc3QgdG9rZW4gPSBzZXJ2ZXIuand0LnNpZ24oeyBzdWI6IHVzZXJJZCwgZW1haWwgfSk7XG5cbiAgICByZXBseS5zZXRDb29raWUoJ3JlZnJlc2gnLCB0b2tlbiwge1xuICAgICAgcGF0aDogJy8nLFxuICAgICAgaHR0cE9ubHk6IHRydWUsXG4gICAgICBzYW1lU2l0ZTogJ2xheCcsXG4gICAgICBzZWN1cmU6IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicsXG4gICAgICBtYXhBZ2U6IDYwICogNjAsXG4gICAgfSk7XG5cbiAgICByZXR1cm4geyB0b2tlbiB9O1xuICB9KTtcblxuICBzZXJ2ZXIuZ2V0KCcvYXBpL3YxL2F1dGgvbWUnLCB7XG4gICAgcHJlSGFuZGxlcjogW2FzeW5jIChyZXF1ZXN0LCByZXBseSkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgcmVxdWVzdC5qd3RWZXJpZnkoKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZXR1cm4gcmVwbHkuc2VuZChlcnIpO1xuICAgICAgfVxuICAgIH1dLFxuICAgIHNjaGVtYToge1xuICAgICAgdGFnczogWydhdXRoJ10sXG4gICAgICByZXNwb25zZTogeyAyMDA6IHoub2JqZWN0KHsgdXNlcklkOiB6LnN0cmluZygpLCBlbWFpbDogei5zdHJpbmcoKS5lbWFpbCgpIH0pIH0sXG4gICAgfSxcbiAgfSwgYXN5bmMgKHJlcXVlc3QpID0+IHtcbiAgICBjb25zdCB7IHN1YiwgZW1haWwgfSA9IHJlcXVlc3QudXNlciBhcyB7IHN1Yjogc3RyaW5nOyBlbWFpbDogc3RyaW5nIH07XG4gICAgcmV0dXJuIHsgdXNlcklkOiBzdWIsIGVtYWlsIH07XG4gIH0pO1xuXG4gIC8vIERvbWFpbiByb3V0ZXNcbiAgYXdhaXQgc2VydmVyLnJlZ2lzdGVyKHN0YXRlbWVudHNSb3V0ZXMpO1xuICBhd2FpdCBzZXJ2ZXIucmVnaXN0ZXIoam9ic1JvdXRlcyk7XG5cbiAgcmV0dXJuIHNlcnZlcjtcbn1cblxuLy8gSWYgbm90IGluIHRlc3QgbW9kZSwgc3RhcnQgc2VydmVyIGltbWVkaWF0ZWx5XG5pZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICd0ZXN0Jykge1xuICBidWlsZFNlcnZlcigpLnRoZW4oKHNlcnZlcikgPT4ge1xuICAgIGNvbnN0IHBvcnQgPSBwYXJzZUludChwcm9jZXNzLmVudi5QT1JUIHx8ICczMDAwJywgMTApO1xuICAgIHNlcnZlci5saXN0ZW4oeyBwb3J0LCBob3N0OiAnMC4wLjAuMCcgfSlcbiAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgIHNlcnZlci5sb2cuZXJyb3IoZXJyKTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgfSk7XG4gIH0pO1xufVxuIl0sInZlcnNpb24iOjN9